cmake_minimum_required(VERSION 3.10)

# ESP-IDF Component detection and handling
if(DEFINED IDF_PATH OR DEFINED ENV{IDF_PATH} OR COMMAND idf_component_register)
    # We're in ESP-IDF environment - register as component
    include(${CMAKE_CURRENT_LIST_DIR}/cmake/esp32.cmake)
    return()
endif()

# Standalone build (not ESP-IDF)
project(libiohub VERSION 1.0.0)

if (IOHUB_PLATFORM STREQUAL "MPSSE")
    include(FetchContent)
    FetchContent_Declare(
        libmpsse
        GIT_REPOSITORY https://github.com/SjB/libmpsse.git
        GIT_TAG        master
    )
    FetchContent_MakeAvailable(libmpsse)

    # Create mpsse library since libmpsse doesn't have CMakeLists.txt
    add_library(mpsse STATIC 
        ${libmpsse_SOURCE_DIR}/src/mpsse.c
        ${libmpsse_SOURCE_DIR}/src/fast.c
        ${libmpsse_SOURCE_DIR}/src/support.c
    )

    target_include_directories(mpsse PUBLIC ${libmpsse_SOURCE_DIR}/src)
    
    # You may need to link against libftdi1 or similar USB library
    # target_link_libraries(mpsse ftdi1)  # Uncomment and adjust as needed
endif()

add_subdirectory(src)
add_subdirectory(cli)
